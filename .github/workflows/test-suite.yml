name: Comprehensive Test Suite

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # Test matrix for multiple platforms and versions
  test-matrix:
    name: Test Matrix
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [18, 20]
        python-version: ['3.10', '3.11']
        exclude:
          # macOS doesn't support all Python versions
          - os: macos-latest
            python-version: '3.10'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: ui/robot-controller-ui/package-lock.json
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install frontend dependencies
        working-directory: ui/robot-controller-ui
        run: npm ci
      
      - name: Install backend dependencies
        working-directory: servers/robot-controller-backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run frontend unit tests
        working-directory: ui/robot-controller-ui
        run: npm test -- --watchAll=false --coverage
      
      - name: Run backend unit tests
        working-directory: servers/robot-controller-backend
        run: pytest tests/unit -v --cov=. --cov-report=xml -m "not hardware"
      
      - name: Run hybrid system tests
        working-directory: servers/robot-controller-backend
        run: pytest tests/hybrid -v
      
      - name: Run fault injection tests
        working-directory: servers/robot-controller-backend
        run: pytest tests/faults -v

  # Separate jobs for specialized tests
  frontend-unit-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ui/robot-controller-ui/package-lock.json
      
      - name: Install dependencies
        working-directory: ui/robot-controller-ui
        run: npm ci
      
      - name: Run unit tests
        working-directory: ui/robot-controller-ui
        run: npm test -- --coverage --watchAll=false
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ui/robot-controller-ui/coverage/lcov.info
          flags: frontend-unit

  frontend-e2e-tests:
    name: Frontend E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ui/robot-controller-ui/package-lock.json
      
      - name: Install dependencies
        working-directory: ui/robot-controller-ui
        run: npm ci
      
      - name: Start backend services
        run: |
          # Start mock backend services for E2E tests
          docker-compose up -d || echo "Docker not available"
      
      - name: Run E2E tests
        working-directory: ui/robot-controller-ui
        run: npm run test:e2e:ci
      
      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: cypress-screenshots
          path: ui/robot-controller-ui/cypress/screenshots

  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: servers/robot-controller-backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: Run unit tests
        working-directory: servers/robot-controller-backend
        run: pytest tests/unit -v --cov=. --cov-report=xml --cov-report=html -m "not hardware"
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: servers/robot-controller-backend/coverage.xml
          flags: backend-unit

  backend-integration-tests:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: servers/robot-controller-backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
      
      - name: Start test services
        run: |
          # Start minimal services for integration tests
          cd servers/robot-controller-backend
          python -m uvicorn main_api:app --host 0.0.0.0 --port 8000 &
          sleep 5
      
      - name: Run integration tests
        working-directory: servers/robot-controller-backend
        run: pytest tests/integration -v -m integration

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Frontend security audit
        working-directory: ui/robot-controller-ui
        run: |
          npm ci
          npm audit --audit-level=moderate || true
          npm run security:scan || true
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install security tools
        run: |
          pip install bandit safety
      
      - name: Backend security scan
        working-directory: servers/robot-controller-backend
        run: |
          bandit -r . -f json -o security-report.json || true
          safety check || true
      
      - name: Run security tests
        working-directory: servers/robot-controller-backend
        run: |
          pip install -r requirements.txt
          pytest tests/security -v -m security

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: servers/robot-controller-backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-benchmark locust
      
      - name: Run performance tests
        working-directory: servers/robot-controller-backend
        run: pytest tests/performance -v -m performance

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: 
      - frontend-unit-tests
      - frontend-e2e-tests
      - backend-unit-tests
      - backend-integration-tests
      - security-tests
      - performance-tests
    if: always()
    steps:
      - name: Test Summary
        run: |
          echo "## Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "All test suites completed" >> $GITHUB_STEP_SUMMARY

